<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æ•°æ®æºç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0d0d0d; color: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        .login-box { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 40px; width: 400px; }
        .login-title { font-size: 24px; text-align: center; margin-bottom: 30px; color: #07c160; }
        .login-input { width: 100%; padding: 12px 16px; background: #111; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 14px; margin-bottom: 20px; }
        .login-btn { width: 100%; padding: 12px; background: #07c160; border: none; border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer; }
        .login-btn:hover { background: #06ad56; }
        .login-error { color: #ff4444; text-align: center; margin-top: 15px; font-size: 13px; display: none; }
        
        .main-container { display: none; width: 100%; max-width: 900px; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #07c160; font-size: 24px; }
        .back-btn { padding: 8px 16px; background: #333; border: none; border-radius: 6px; color: #888; font-size: 12px; cursor: pointer; text-decoration: none; }
        .back-btn:hover { background: #444; color: #fff; }
        
        .source-list { margin-bottom: 30px; }
        .source-item { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .source-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .source-name { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .source-name .status { width: 8px; height: 8px; border-radius: 50%; }
        .source-name .status.online { background: #07c160; box-shadow: 0 0 8px #07c160; }
        .source-name .status.offline { background: #ff4444; }
        .source-type { padding: 3px 8px; font-size: 10px; border-radius: 4px; }
        .source-type.direct { background: rgba(0, 212, 170, 0.2); color: #00d4aa; }
        .source-type.bridge { background: rgba(255, 204, 0, 0.2); color: #fc0; }
        .source-info { font-size: 12px; color: #666; margin-bottom: 4px; }
        .source-actions { display: flex; gap: 8px; }
        .source-btn { padding: 6px 12px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; }
        .source-btn.toggle { background: rgba(0, 212, 170, 0.2); color: #00d4aa; }
        .source-btn.toggle.disabled { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .source-btn.delete { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        
        .add-form { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; }
        .form-title { font-size: 16px; margin-bottom: 20px; color: #fff; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-label { font-size: 12px; color: #888; margin-bottom: 6px; display: block; }
        .form-input { width: 100%; padding: 10px 12px; background: #111; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 13px; }
        .form-select { width: 100%; padding: 10px 12px; background: #111; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 13px; }
        .form-hint { font-size: 11px; color: #555; margin-top: 6px; }
        .form-btn { padding: 10px 24px; background: #07c160; border: none; border-radius: 6px; color: #fff; font-size: 13px; cursor: pointer; }
        .form-btn:hover { background: #06ad56; }
        
        .empty { text-align: center; color: #555; padding: 40px; }
        .empty-icon { font-size: 48px; opacity: 0.3; margin-bottom: 10px; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: #333; border-radius: 6px; font-size: 13px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; }
        .toast.success { background: rgba(7, 193, 96, 0.9); }
        .toast.error { background: rgba(255, 68, 68, 0.9); }
        
        .bridge-info { background: #111; border: 1px solid #333; border-radius: 6px; padding: 15px; margin-top: 20px; }
        .bridge-info h3 { font-size: 14px; color: #fc0; margin-bottom: 10px; }
        .bridge-info p { font-size: 12px; color: #888; margin-bottom: 8px; }
        .bridge-info code { background: #1a1a1a; padding: 2px 6px; border-radius: 3px; color: #07c160; font-family: monospace; }
    </style>
</head>
<body>
    <!-- ç™»å½•æ¡† -->
    <div class="login-box" id="loginBox">
        <div class="login-title">ğŸ” å¾®ä¿¡æ•°æ®æºç®¡ç†</div>
        <input type="password" class="login-input" id="passwordInput" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç " onkeypress="if(event.key==='Enter')login()">
        <button class="login-btn" onclick="login()">ç™» å½•</button>
        <div class="login-error" id="loginError">å¯†ç é”™è¯¯</div>
    </div>
    
    <!-- ä¸»ç•Œé¢ -->
    <div class="main-container" id="mainContainer">
        <div class="header">
            <h1>ğŸ“¡ å¾®ä¿¡æ•°æ®æºç®¡ç†</h1>
            <a href="/" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        </div>
        
        <div class="source-list" id="sourceList"></div>
        
        <div class="add-form">
            <div class="form-title">â• æ·»åŠ æ•°æ®æº</div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">æ•°æ®æºID *</label>
                    <input type="text" class="form-input" id="sourceId" placeholder="å¦‚: wx1">
                </div>
                <div class="form-group">
                    <label class="form-label">åç§°</label>
                    <input type="text" class="form-input" id="sourceName" placeholder="å¦‚: æˆ‘çš„å¾®ä¿¡">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">è¿æ¥ç±»å‹ *</label>
                    <select class="form-select" id="sourceType" onchange="toggleFields()">
                        <option value="direct">ç›´è¿ (æœåŠ¡å™¨ç›´æ¥è¿æ¥åƒå¯»)</option>
                        <option value="bridge">æ¡¥æ¥ (æœ¬åœ°è¿è¡Œbridge.js)</option>
                    </select>
                </div>
            </div>
            
            <!-- ç›´è¿æ¨¡å¼å­—æ®µ -->
            <div id="directFields">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">HTTP åœ°å€ (åƒå¯»API)</label>
                        <input type="text" class="form-input" id="httpUrl" placeholder="http://127.0.0.1:8888">
                        <div class="form-hint">åƒå¯»æ¡†æ¶çš„åœ°å€ï¼Œå¦‚ http://127.0.0.1:8888 (ä¸éœ€è¦åŠ  /wechat/httpapi)</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="background:#111;padding:10px;border-radius:6px">
                        <div class="form-hint" style="color:#fc0">âš ï¸ å›è°ƒåœ°å€è®¾ç½®</div>
                        <div class="form-hint">åœ¨åƒå¯»æ¡†æ¶ä¸­è®¾ç½®å›è°ƒåœ°å€ä¸º: <span style="color:#07c160" id="directCallbackHint">http://æœåŠ¡å™¨IP:3000/api/wx/callback?source=æ•°æ®æºID</span></div>
                    </div>
                </div>
            </div>
            
            <!-- æ¡¥æ¥æ¨¡å¼å­—æ®µ -->
            <div id="bridgeFields" style="display:none">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¾®ä¿¡ID (wxid) *</label>
                        <input type="text" class="form-input" id="bridgeWxid" placeholder="wxid_xxxxxxxxxx">
                        <div class="form-hint">æ¡¥æ¥å®¢æˆ·ç«¯çš„å¾®ä¿¡IDï¼Œç”¨äºè®¤è¯</div>
                    </div>
                </div>
            </div>
            
            <button class="form-btn" onclick="addSource()">æ·»åŠ æ•°æ®æº</button>
        </div>
        
        <div class="bridge-info">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>æ–¹å¼ä¸€ï¼šç›´è¿æ¨¡å¼</strong>ï¼ˆæœåŠ¡å™¨èƒ½è®¿é—®åƒå¯»æ¡†æ¶ï¼‰</p>
            <p>1. åœ¨åƒå¯»æ¡†æ¶è®¾ç½®å›è°ƒåœ°å€: <code id="callbackUrl">http://ä½ çš„æœåŠ¡å™¨IP:3000/api/wx/callback?source=æ•°æ®æºID</code></p>
            <p>2. HTTPåœ°å€å¡«åƒå¯»çš„API: <code>http://åƒå¯»IP:8888/wechat/httpapi</code></p>
            <p style="margin-top:15px"><strong>æ–¹å¼äºŒï¼šæ¡¥æ¥æ¨¡å¼</strong>ï¼ˆæœåŠ¡å™¨æ— æ³•è®¿é—®åƒå¯»ï¼Œå¦‚å†…ç½‘/å®¶é‡Œç”µè„‘ï¼‰</p>
            <p>1. ä¸‹è½½ <code>bridge.js</code> åˆ°æœ¬åœ°ç”µè„‘</p>
            <p>2. ä¿®æ”¹é…ç½®ï¼š<code>serverUrl</code> æ”¹ä¸ºæœåŠ¡å™¨åœ°å€ï¼Œ<code>wxid</code> æ”¹ä¸ºä½ çš„å¾®ä¿¡ID</p>
            <p>3. åœ¨åƒå¯»æ¡†æ¶è®¾ç½®å›è°ƒåœ°å€æŒ‡å‘æœ¬åœ°bridge: <code>http://127.0.0.1:9898/wechat/callback</code></p>
            <p>4. è¿è¡Œï¼š<code>node bridge.js</code></p>
            <p>5. æ¡¥æ¥è¿æ¥åœ°å€ï¼š<code id="bridgeUrl">ws://localhost:3000/bridge</code></p>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let authenticated = false;
        
        function showToast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show ' + type;
            setTimeout(() => t.className = 'toast', 2000);
        }
        
        async function login() {
            const password = document.getElementById('passwordInput').value;
            const res = await fetch('/api/wx/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();
            
            if (data.code === 200) {
                authenticated = true;
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                loadSources();
                
                // æ›´æ–°æ¡¥æ¥åœ°å€
                const host = window.location.host;
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                document.getElementById('bridgeUrl').textContent = `${protocol}//${host}/bridge`;
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => document.getElementById('loginError').style.display = 'none', 2000);
            }
        }
        
        function toggleFields() {
            const type = document.getElementById('sourceType').value;
            document.getElementById('directFields').style.display = type === 'direct' ? 'block' : 'none';
            document.getElementById('bridgeFields').style.display = type === 'bridge' ? 'block' : 'none';
        }
        
        async function loadSources() {
            const res = await fetch('/api/wx/sources');
            const data = await res.json();
            const sources = data.code === 200 ? data.data : {};
            const list = Object.entries(sources);
            
            if (!list.length) {
                document.getElementById('sourceList').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“¡</div>
                        <div>æš‚æ— æ•°æ®æºï¼Œè¯·æ·»åŠ </div>
                    </div>
                `;
                return;
            }
            
            document.getElementById('sourceList').innerHTML = list.map(([id, s]) => `
                <div class="source-item">
                    <div class="source-header">
                        <div class="source-name">
                            <span class="status ${s.online ? 'online' : 'offline'}"></span>
                            ${s.name}
                            <span class="source-type ${s.type || 'direct'}">${s.type === 'bridge' ? 'æ¡¥æ¥' : 'ç›´è¿'}</span>
                        </div>
                        <div class="source-actions">
                            <button class="source-btn toggle ${s.enabled ? '' : 'disabled'}" onclick="toggleSource('${id}')">${s.enabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨'}</button>
                            <button class="source-btn delete" onclick="deleteSource('${id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="source-info">ID: ${id}</div>
                    ${s.type === 'bridge' 
                        ? `<div class="source-info">å¾®ä¿¡ID: ${s.bridgeWxid || '-'}</div>` 
                        : `<div class="source-info">HTTP: ${s.httpUrl || '-'}</div>
                           <div class="source-info">å›è°ƒ: http://æœåŠ¡å™¨IP:3000/api/wx/callback?source=${id}</div>`
                    }
                    <div class="source-info">çŠ¶æ€: ${s.online ? 'ğŸŸ¢ åœ¨çº¿' : 'âšª ç­‰å¾…å›è°ƒ'}</div>
                </div>
            `).join('');
        }
        
        async function addSource() {
            const id = document.getElementById('sourceId').value.trim();
            const name = document.getElementById('sourceName').value.trim();
            const type = document.getElementById('sourceType').value;
            const httpUrl = document.getElementById('httpUrl').value.trim();
            const bridgeWxid = document.getElementById('bridgeWxid').value.trim();
            
            if (!id) { showToast('è¯·è¾“å…¥æ•°æ®æºID', 'error'); return; }
            if (type === 'bridge' && !bridgeWxid) { showToast('æ¡¥æ¥æ¨¡å¼éœ€è¦å¡«å†™å¾®ä¿¡ID', 'error'); return; }
            
            await fetch('/api/wx/sources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, name: name || id, type, httpUrl, bridgeWxid, enabled: true })
            });
            
            document.getElementById('sourceId').value = '';
            document.getElementById('sourceName').value = '';
            document.getElementById('httpUrl').value = '';
            document.getElementById('bridgeWxid').value = '';
            
            loadSources();
            showToast('æ•°æ®æºå·²æ·»åŠ ', 'success');
        }
        
        async function toggleSource(id) {
            const res = await fetch('/api/wx/sources');
            const data = await res.json();
            const source = data.data?.[id];
            if (source) {
                await fetch('/api/wx/sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...source, enabled: !source.enabled })
                });
                loadSources();
            }
        }
        
        async function deleteSource(id) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ•°æ®æº ${id} å—ï¼Ÿ`)) return;
            await fetch(`/api/wx/sources/${id}`, { method: 'DELETE' });
            loadSources();
            showToast('å·²åˆ é™¤', 'success');
        }
        
        // å®šæ—¶åˆ·æ–°
        setInterval(() => {
            if (authenticated) loadSources();
        }, 5000);
    </script>
</body>
</html>